---
import BaseHead from "@/components/BaseHead.astro";
import paperTexture from "@/assets/paper-texture.webp";
import BorderDark from "@/assets/border-dark.svg";
import BorderLight from "@/assets/border-light.svg";
import CornerTopRight from "@/assets/corner-top-right.svg";
import CornerTopLeft from "@/assets/corner-top-left.svg";
import HomeSmile from "@/assets/home-smile.svg";
import Feedback from "@/assets/feedback.svg";
import { ClientRouter } from "astro:transitions";

import ThemeToggleButton from "@/components/ThemeToggleButton.astro";
import LanguagePicker from "@/components/LanguagePicker.astro";
import FeedbackModal from "@/components/FeedbackModal.astro";

import { type Language } from "@/i18n/ui.ts";
import {
    getLangFromUrl,
    useTranslatedPath,
    getRouteFromUrl,
} from "@/i18n/utils.ts";

const { title, description } = Astro.props;
const { currentLocale } = Astro;

const lang = (currentLocale as Language) || getLangFromUrl(Astro.url);
const translatePath = useTranslatedPath(lang);

const isHome = getRouteFromUrl(Astro.url) === "/";
---

<!doctype html>
<html lang={currentLocale} transition:animate="none">
    <head>
        <ClientRouter />
        <BaseHead title={title} description={description} />

        <!-- Preload Critical Assets -->
        <link rel="preload" as="image" href={BorderDark.src} />
        <link rel="preload" as="image" href={BorderLight.src} />

        <!-- TODO: organize global styles better -->
        <style is:global>
            /* Modern CSS Reset */
            *,
            *::before,
            *::after {
                box-sizing: border-box;
            }

            * {
                margin: 0;
            }

            html {
                -webkit-text-size-adjust: 100%;
                text-size-adjust: 100%;
            }

            body {
                min-height: 100dvh;
                line-height: 1.5;
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }

            img,
            picture,
            video,
            canvas,
            svg {
                display: block;
                max-width: 100%;
            }

            input,
            button,
            textarea,
            select {
                font: inherit;
            }

            button {
                border: none;
                cursor: pointer;
                background-color: transparent;
            }

            p,
            h1,
            h2,
            h3,
            h4,
            h5,
            h6 {
                overflow-wrap: break-word;
            }
        </style>

        <style
            is:global
            define:vars={{
                paperTexture: `url("${paperTexture.src}")`,
                markBorder: `url("${BorderDark.src}")`,
                borderLight: `url("${BorderLight.src}")`,
            }}
        >
            /* Critical CSS: Start hidden to prevent FOUC */
            body:not(.loaded) .container {
                opacity: 0;
                visibility: hidden;
            }
            body.loaded .container {
                opacity: 1;
                visibility: visible;
                transition: opacity 0.5s ease-out;
            }

            /* No-JS Fallback */
            noscript body .container {
                opacity: 1 !important;
                visibility: visible !important;
            }

            @font-face {
                font-family: "Excalifont";
                src: url("../assets/fonts/Excalifont-Regular.woff2")
                    format("woff2");
                font-weight: normal;
                font-style: normal;
                font-display: swap;
            }

            @font-face {
                font-family: "Comic Shanns";
                src: url("../assets/fonts/comic-shanns.otf") format("opentype");
                font-weight: normal;
                font-style: normal;
                font-display: swap;
            }

            :root {
                --primary-bg: #f5f5f5;
                --primary-text: #333;
                --primary-bg-inverted: #333;
                --primary-text-inverted: #f5f5f5;
                --bg-container: #ffffff;
                --primar-text: #000000;
                --link-color: #0066cc;
                --accent-blue: #0066cc;
                --paper-opacity: 0.8;

                --border-line: #c0c0c0;
            }

            html {
                font-family: "Comic Shanns", cursive, sans-serif;
            }

            body {
                line-height: 1.6;
                font-size: 1rem;
                background-color: var(--primary-bg);
                color: var(--primary-text);
                position: relative;
                display: grid;
                place-items: center;
                height: 100dvh;
                min-height: 100dvh;
            }
            main {
                max-width: 1200px;
                height: 100%;
                margin: 0 auto;
                transition:
                    background-color 0.3s,
                    color 0.3s;
            }
            .mark {
                position: relative;

                border: 30px solid transparent;
                border-image-source: var(--borderLight);
                border-image-slice: 200;
                border-image-repeat: stretch;

                width: 100%;
                height: 100dvh;
                min-height: 100dvh;
            }

            /* TODO: delete or change it maybe cause svg's errors */
            .dark .mark {
                border-image-source: var(--markBorder);
                & svg:first {
                    fill: var(--primar-text);
                }
            }

            body::before {
                content: "";
                position: absolute;
                inset: 0;
                background-image: var(--paperTexture);
                background-repeat: repeat;
                pointer-events: none;
                z-index: -1;
            }

            body::after {
                content: "";
                position: absolute;
                inset: 0;
                pointer-events: none;
                z-index: -1;
                background-image: 
                    /* Líneas gruesas cada 5 cuadros */
                    linear-gradient(
                        rgba(128, 128, 128, 0.06) 1px,
                        transparent 1px
                    ),
                    linear-gradient(
                        90deg,
                        rgba(128, 128, 128, 0.06) 1px,
                        transparent 1px
                    ),
                    /* Líneas finas */
                    linear-gradient(
                            rgba(128, 128, 128, 0.05) 1px,
                            transparent 1px
                        ),
                    linear-gradient(
                        90deg,
                        rgba(128, 128, 128, 0.05) 1px,
                        transparent 1px
                    );
                background-size:
                    100px 100px,
                    100px 100px,
                    20px 20px,
                    20px 20px;
            }
            html.dark body::after {
                background-image:
                    linear-gradient(
                        rgba(255, 255, 255, 0.016) 1px,
                        transparent 1px
                    ),
                    linear-gradient(
                        90deg,
                        rgba(255, 255, 255, 0.016) 1px,
                        transparent 1px
                    ),
                    linear-gradient(rgba(55, 55, 55, 0.1) 1px, transparent 1px),
                    linear-gradient(
                        90deg,
                        rgba(55, 55, 55, 0.1) 1px,
                        transparent 1px
                    );
                background-size:
                    100px 100px,
                    100px 100px,
                    20px 20px,
                    20px 20px;
            }
            html.dark {
                --primary-bg: #333;
                --primary-text: #eee;
                --primary-bg-inverted: #f5f5f5;
                --primary-text-inverted: #333;
                --paper-opacity: 0;
                --accent-blue: #549eff;

                --border-line: #666666aa;

                & body::before {
                    filter: invert(1);
                }
            }

            h1 {
                font-size: 2.5rem;
                margin: 0 0 1rem 0;
                font-weight: bold;
                font-family: "Excalifont", sans-serif;
            }

            h2,
            h3,
            h4,
            h5,
            h6 {
                font-size: 1.5rem;
                font-family: "Excalifont", sans-serif;
                margin-bottom: 1rem;
            }

            p {
                text-wrap: balance;
                opacity: 0.9;
            }

            a {
                color: var(--accent-blue);
            }

            a {
                transition: transform 0.1s ease-in-out;
                &:hover {
                    transform: scale(1.05);
                }
            }
            .bright {
                width: 2.5rem;
                border: 0;
                background: none;
                cursor: pointer;
                transition: filter 0.1s ease-in-out;
            }
            .bright:hover {
                transform: scale(1);
                filter: drop-shadow(
                    0 0 10px
                        color-mix(in srgb, var(--primary-text), transparent 10%)
                );
            }

            .see-more {
                margin-top: auto;
                font-size: 0.9rem;
                color: var(--accent-blue);
                font-weight: bold;
                text-align: end;
                display: flex;
                justify-content: end;

                a {
                    text-decoration: none;
                    padding: 0.25rem 0.5rem;
                    display: inline-block;
                }

                a:hover {
                    text-decoration: underline;
                    text-underline-offset: 3px;
                    text-decoration-thickness: 2px;
                }

                a::after {
                    content: " >";
                }
            }

            /* Responsive Adjustments */
            @media (width <= 1000px) {
                body {
                    height: max-content;
                }
                .mark {
                    height: max-content;
                    border-width: 15px;
                }
                .see-more {
                    margin-top: 1rem;
                }
            }
        </style>

        <style>
            .corner-top-right {
                position: absolute;
                top: -25px;
                right: -25px;
                z-index: 999;
                width: 100px;
                height: auto;

                & svg {
                    height: 100%;
                }
            }
            /* Responsive Adjustments */
            @media (width <= 1000px) {
                .corner-top-right {
                    top: -12.9px !important;
                    right: -12.6px !important;
                }
            }
        </style>

        <style>
            .corner-top-left {
                position: absolute;
                top: -25px;
                left: -25px;
                z-index: 99;
                width: 50px;
                height: 50px;

                & svg {
                    height: 100%;
                }
            }

            a.home-link {
                position: absolute;
                width: 2rem;
                padding: 5px;
                margin-top: 0.2rem;
                margin-left: 0.2rem;
                display: block;
                top: 0;
            }

            .home-link :global(svg) {
                height: 100%;
            }

            @media (width <= 1000px) {
                .corner-top-left {
                    top: -12px !important;
                    left: -12px !important;
                }
            }

            .feedback-button {
                position: fixed;
                bottom: 1rem;
                right: 1rem;
                z-index: 9999;
                width: 3rem;
                height: 3rem;
                border-radius: 100%;
                display: block;
                border: 0.5px solid var(--border-line);
                background-color: var(--primary-bg);
                box-shadow: 0 0 15px rgba(0, 0, 0, 0.05);
                display: flex;
                justify-content: center;
                align-items: center;
                cursor: pointer;
                transition: transform 0.1s ease-in-out;
                &:hover {
                    transform: scale(1.05);
                }

                & svg {
                    height: 100%;
                }
            }
        </style>
        <!-- Google tag (gtag.js) -->
        <script
            async
            src="https://www.googletagmanager.com/gtag/js?id=G-WJSJQ78QYQ"
        ></script>
        <script is:inline>
            window.dataLayer = window.dataLayer || [];
            function gtag() {
                dataLayer.push(arguments);
            }
            gtag("js", new Date());
            gtag("config", "G-WJSJQ78QYQ");
        </script>
    </head>
    <body style={!isHome ? "height: max-content" : ""}>
        <style>
            .options {
                display: flex;
                width: 100px;
                /* background-color: rgba(0, 128, 128, 0.3); */
                position: absolute;
                top: 0;
                right: 0;
                z-index: 9999;
                gap: 0.5rem;
                padding: 0.8rem 1rem;
            }
        </style>
        <div class="options">
            <LanguagePicker />
            <ThemeToggleButton />
        </div>
        <div class="mark" style={!isHome ? "height: max-content" : ""}>
            <div class="corner-top-left" style={isHome ? "display: none" : ""}>
                <CornerTopLeft />
                <a href={translatePath("/")} class="home-link">
                    <HomeSmile />
                </a>
            </div>

            <CornerTopRight class="corner-top-right" />
            <main transition:animate="slide">
                <slot />
            </main>
        </div>
        <button
            class="feedback-button"
            title="¿Tienes algo que decir?"
            commandfor="feedback-modal"
            command="show-modal"
        >
            <Feedback />
        </button>
        <FeedbackModal />
    </body>
</html>
