---
import Avatar from "@/assets/avatar.svg";
---

<div class="bio-image-container">
    <div class="bio-image">
        <Avatar />
    </div>
</div>

<script>
    interface BubbleState {
        element: HTMLDivElement | null;
        hideTimeout: number | null;
        currentMessageIndex: number;
        isVisible: boolean;
    }

    // Función para crear parpadeo natural
    function initBlink(): void {
        const eyeLeft = document.getElementById("eye-open-left") as HTMLElement;
        const eyeRight = document.getElementById(
            "eye-open-right",
        ) as HTMLElement;

        if (!eyeLeft || !eyeRight) return;

        function blink(): void {
            eyeLeft.style.opacity = "0";
            eyeRight.style.opacity = "0";

            setTimeout(() => {
                eyeLeft.style.opacity = "1";
                eyeRight.style.opacity = "1";
            }, 150);
        }

        function scheduleBlink(): void {
            const randomDelay = Math.random() * 4000 + 2000;

            setTimeout(() => {
                blink();
                scheduleBlink();
            }, randomDelay);
        }

        eyeLeft.style.transition = "opacity 0.1s ease";
        eyeRight.style.transition = "opacity 0.1s ease";

        scheduleBlink();
    }

    // Función para mostrar mensaje "hola"
    function initSpeechBubble(): void {
        const container = document.querySelector(
            ".bio-image-container",
        ) as HTMLElement;
        const svg = document.querySelector(".bio-image svg") as SVGElement;

        if (!container || !svg) return;

        const state: BubbleState = {
            element: null,
            hideTimeout: null,
            currentMessageIndex: 0,
            isVisible: false,
        };

        const messages: readonly string[] = [
            "¡Hola!",
            "¿Qué hay de\nnuevo viejo?",
            "Hey buddy!",
            "¿Cómo estás?",
            "¡Saludos!",
            "Nice to\nsee you!",
            "¿Todo bien?",
            "¡Qué pasa!",
        ] as const;

        function showBubble(message: string): void {
            if (!state.element) return;

            state.element.textContent = message;
            state.element.style.opacity = "1";
            state.element.style.transform =
                "translateX(-50%) scale(1) translateY(0)";
            state.isVisible = true;
        }

        function hideBubble(callback?: () => void): void {
            if (!state.element) return;

            state.element.style.opacity = "0";
            state.element.style.transform =
                "translateX(-50%) scale(0.8) translateY(-5px)";
            state.isVisible = false;

            if (callback) {
                setTimeout(callback, 300);
            }
        }

        function createBubbleElement(): HTMLDivElement {
            const bubble = document.createElement("div");
            bubble.className = "speech-bubble";

            Object.assign(bubble.style, {
                position: "absolute",
                top: "auto",
                bottom: "100%",
                left: "50%",
                marginBottom: "15px",
                transform: "translateX(-50%) scale(0) translateY(10px)",
                backgroundColor: "#fff",
                color: "#111",
                padding: "10px 16px",
                borderRadius: "16px",
                fontSize: "14px",
                fontWeight: "600",
                boxShadow: "0 4px 12px rgba(0,0,0,0.15)",
                transition:
                    "transform 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55), opacity 0.3s ease",
                zIndex: "10",
                whiteSpace: "pre-line",
                opacity: "0",
                pointerEvents: "none",
                textAlign: "center",
                lineHeight: "1.3",
                maxWidth: "180px",
                minWidth: "80px",
            } as Partial<CSSStyleDeclaration>);

            const tail = document.createElement("div");
            Object.assign(tail.style, {
                content: '""',
                position: "absolute",
                top: "100%",
                left: "50%",
                marginLeft: "-12px",
                width: "0",
                height: "0",
                borderStyle: "solid",
                borderWidth: "12px 12px 0 12px",
                borderColor: "#fff transparent transparent transparent",
                zIndex: "1",
            } as Partial<CSSStyleDeclaration>);

            bubble.appendChild(tail);
            return bubble;
        }

        function showNextMessage(): void {
            state.currentMessageIndex =
                (state.currentMessageIndex + 1) % messages.length;

            requestAnimationFrame(() => {
                requestAnimationFrame(() => {
                    showBubble(messages[state.currentMessageIndex]);

                    state.hideTimeout = window.setTimeout(() => {
                        hideBubble();
                    }, 2500);
                });
            });
        }

        function handleInteraction(e: Event): void {
            e.stopPropagation();

            // Crear bubble si no existe
            if (!state.element) {
                state.element = createBubbleElement();
                container.style.position = "relative";
                container.appendChild(state.element);
            }

            // Limpiar timeout anterior
            if (state.hideTimeout !== null) {
                clearTimeout(state.hideTimeout);
            }

            if (state.isVisible) {
                hideBubble(() => {
                    showNextMessage();
                });
            } else {
                requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                        showBubble(messages[state.currentMessageIndex]);

                        state.hideTimeout = window.setTimeout(() => {
                            hideBubble();
                        }, 2500);
                    });
                });
            }
        }

        // Event listeners
        container.addEventListener("pointerdown", handleInteraction);
        svg.addEventListener("pointerdown", handleInteraction);

        container.addEventListener("touchend", (e: TouchEvent) => {
            e.preventDefault();
            handleInteraction(e);
        });
    }

    // Inicializar cuando el DOM esté listo
    function init(): void {
        initBlink();
        initSpeechBubble();
    }

    if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", init);
    } else {
        init();
    }
</script>

<style>
    .bio-image-container {
        float: right;
        padding: 1rem;
        padding-top: 0;
        border-radius: 12px;
        min-height: 50%;
        width: 140px;

        /* CORRECCIONES CRÍTICAS */
        position: relative;
        z-index: 1;
        overflow: visible;
    }

    .bio-image {
        padding: 0;
        transition: transform 0.3s ease;
        perspective: 100px;
        transform-style: preserve-3d;
        transform: rotate(0deg);
        display: flex;
        justify-content: center;
        align-items: center;
        user-select: none;
        float: none;

        position: relative;
        z-index: 2;
        width: 100%;
        height: 100%;

        /* Animación discreta de entrada (balanceo) */
        transform-origin: bottom center;
        animation: sway 0.5s ease-out both;
        animation-iteration-count: 1;

        &:hover {
            transform: rotate(0deg);
        }
    }

    @keyframes sway {
        0% {
            transform: rotate(0deg);
        }
        20% {
            transform: rotate(-6deg);
        }
        40% {
            transform: rotate(6deg);
        }
        60% {
            transform: rotate(-3deg);
        }
        80% {
            transform: rotate(2deg);
        }
        100% {
            transform: rotate(0deg);
        }
    }

    svg {
        cursor: pointer;
        user-select: none;
        transition: transform 0.3s ease;
        height: max-content;
        width: 100%;

        transform: rotateY(-10deg) translateX(-5px);
        pointer-events: auto;
        max-width: 100%;

        &:hover {
            transform: rotateY(0deg) scale(1.05) translateX(0px);
        }
    }
</style>
