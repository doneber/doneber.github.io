---
import avatar from "@/assets/avatar.png";

interface Props {
    shortDescription: string;
    fullDescription: string;
}

const { shortDescription, fullDescription } = Astro.props;

import buttonBackgroundImage from "@/assets/button-bg.svg";
---

<div class="bio box">
    <div class="bio-content">
        <h1>@doneber</h1>
        <div>
            <h3 class="short-description">
                {shortDescription}
            </h3>
            <img src={avatar.src} class="bio-image" alt="Avatar" width="120" />

            <p class="bio-text">
                {fullDescription}
            </p>
        </div>

        <a
            href="mailto:contact@doneber.dev"
            class="contact-btn"
            style={{ "background-image": `url(${buttonBackgroundImage.src})` }}
        >
            <svg
                xmlns="http://www.w3.org/2000/svg"
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                ><rect width="20" height="16" x="2" y="4" rx="2"></rect><path
                    d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path></svg
            >
            Contact me
        </a>
    </div>
    <div class="see-more">
        <a href="/about">Sobre mí</a>
    </div>
</div>

<style>
    h1 {
        transform: rotate(-0.2deg);
        font-size: 3rem;
        margin-bottom: 0;
    }
    .bio-content {
        flex-direction: row;
        justify-content: space-between;
        align-items: flex-start;
    }

    .short-description {
        font-size: 1.3rem;
        line-height: 1.4;
        margin-bottom: 1rem;
        max-width: 90%;
    }

    .bio-text {
        font-size: 1rem;
        line-height: 1.5;
        margin-bottom: 2rem;
        max-width: 90%;
        transform: rotate(-0.1deg);
    }

    .contact-btn {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        color: var(--bg-container);
        padding: 0.5rem 1rem;
        border-radius: 8px;
        text-decoration: none;
        font-weight: bold;
        transition: transform 0.1s;
        transform: rotate(0.5deg);
    }

    html.dark .contact-btn {
        filter: invert(0.95);
    }
    html.dark .contact-btn:hover {
        filter: invert(1);
        transform: scale(1.05);
    }

    a.contact-btn {
        background-size: cover;
    }

    .contact-btn:hover {
        transform: scale(1.05);
    }
</style>

<script>
    function applyLineVariation(
        selector: string,
        maxOffset: number = 20,
        minOffset: number = 0,
        verticalVariation: number = 1,
    ): void {
        const container = document.querySelector<HTMLElement>(selector);
        if (!container) return;

        const text = container.textContent || "";
        const fragment = document.createDocumentFragment();

        // Pre-calcular offsets verticales para reutilizar (evita Math.random en loop)
        const letterOffsets: number[] = [];
        const totalChars = text.length;
        for (let i = 0; i < totalChars; i++) {
            letterOffsets[i] = (Math.random() - 0.5) * 2 * verticalVariation;
        }

        // Single pass: construir todo en una pasada
        let charIndex = 0;
        let wordSpan: HTMLSpanElement | null = null;
        const wordSpans: HTMLSpanElement[] = [];

        for (let i = 0; i < totalChars; i++) {
            const char = text[i];

            if (char === " " || char === "\n" || char === "\t") {
                if (wordSpan) {
                    fragment.appendChild(wordSpan);
                    wordSpans.push(wordSpan);
                    wordSpan = null;
                }
                fragment.appendChild(document.createTextNode(char));
            } else {
                if (!wordSpan) {
                    wordSpan = document.createElement("span");
                    wordSpan.style.display = "inline-block";
                }

                const letterSpan = document.createElement("span");
                letterSpan.textContent = char;
                letterSpan.style.cssText = `display:inline-block;transform:translateY(${letterOffsets[charIndex++]}px)`;
                wordSpan.appendChild(letterSpan);
            }
        }

        if (wordSpan) {
            fragment.appendChild(wordSpan);
            wordSpans.push(wordSpan);
        }

        container.textContent = ""; // Más rápido que innerHTML = ''
        container.appendChild(fragment);

        // Batch read: leer todas las posiciones de una vez (un solo reflow)
        requestAnimationFrame(() => {
            const len = wordSpans.length;
            if (len === 0) return;

            // Leer todas las posiciones en un solo pase
            const tops = new Float32Array(len);
            for (let i = 0; i < len; i++) {
                tops[i] = wordSpans[i].getBoundingClientRect().top;
            }

            // Batch write: aplicar transforms
            let currentTop = tops[0];
            let offset = 0;
            let isFirst = true;

            for (let i = 0; i < len; i++) {
                const top = tops[i];

                // Nueva línea detectada
                if (Math.abs(top - currentTop) > 5) {
                    currentTop = top;
                    offset = isFirst
                        ? 0
                        : minOffset + Math.random() * (maxOffset - minOffset);
                    isFirst = false;
                }

                wordSpans[i].style.transform = `translateX(${offset}px)`;
            }
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
        applyLineVariation(".bio-text", 7, 0, 0.4);
    });
</script>
