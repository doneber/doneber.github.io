---
import { parseStringPromise } from "xml2js";
import { getI18N } from "@/i18n";
import Out from "@/assets/out.svg";

const { currentLocale } = Astro;
const i18n = getI18N({ currentLocale });

const ID_CHANNEL_PRIMARY = "UCKMWXwHYoy920OFEN_BM5VQ";
const ID_CHANNEL_SECONDARY = "UCRC7LM5vAZMxS8LSo0PKZng";
const NUMBER_LAST_YT_VIDEOS = 3;

const feedUrl = (id: string) =>
    `https://www.youtube.com/feeds/videos.xml?channel_id=${id}`;

async function loadFeed(feedUrl: string) {
    const response = await fetch(feedUrl);
    const xmlData = await response.text();
    const jsonData = await parseStringPromise(xmlData);
    return jsonData.feed.entry
        .map((entry: any) => ({
            title: entry.title[0],
            link: entry.link[0].$.href,
            thumbnail:
                entry["media:group"]?.[0]["media:thumbnail"]?.[0]?.$.url ||
                "/images/default-video.jpg",
        }))
        .slice(0, NUMBER_LAST_YT_VIDEOS);
}

let allVideos: any[] = [];
try {
    const primaryVideos = (await loadFeed(
        feedUrl(ID_CHANNEL_PRIMARY),
    )) as any[];
    allVideos = [...primaryVideos];

    if (allVideos.length < 3) {
        const secondaryVideos = (await loadFeed(
            feedUrl(ID_CHANNEL_SECONDARY),
        )) as any[];
        allVideos = [...allVideos, ...secondaryVideos];
    }
} catch (e) {
    console.error("Error loading videos", e);
}
const videos = allVideos.slice(0, 3);
---

<div class="videos box">
    <h2>{i18n.HOME.VIDEOS.TITLE}</h2>
    <div class="video-list">
        {
            videos.map((video) => (
                <a href={video.link} target="_blank" class="video-item">
                    <div
                        class="video-thumb"
                        style={`background-image: url(${video.thumbnail || ""}); background-size: cover; background-position: center;`}
                    />
                    <span class="video-title">{video.title}</span>
                </a>
            ))
        }
    </div>
    <div class="see-more">
        <a href="https://youtube.com/@doneber" target="_blank"
            >{i18n.HOME.VIDEOS.SEE_MORE}
            <Out />
        </a>
    </div>
</div>

<style>
    .see-more a {
        display: inline-flex;
        align-items: center;
    }
    .see-more a svg {
        width: 1rem;
        height: 1rem;
        margin-left: 0.5rem;
        transform: scaleX(-1);
    }
    .see-more a::after {
        content: "";
    }
    .video-list {
        display: flex;
        gap: 1rem;
        padding-right: 5rem;
    }

    .video-item {
        flex: 1;
        min-width: 100px;
        text-decoration: none;
        color: inherit;
    }

    .video-thumb {
        width: 100%;
        aspect-ratio: 16/9;
        background-color: #000;
        border-radius: 12px;
        margin-bottom: 0.5rem;
    }

    .video-title {
        font-size: 0.8rem;
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
        font-weight: bold;
    }
    @media (width <= 1400px) {
        .video-list {
            padding-right: 12rem;
            flex-wrap: wrap;
        }
    }
    @media (width <= 1280px) {
        .video-list {
            padding-right: 8rem;
            flex-wrap: wrap;
        }
    }
    @media (width <= 1000px) {
        .video-list {
            padding-right: 0rem;
            flex-wrap: wrap;
        }

        .video-item:last-child {
            display: none;
        }
    }
</style>
