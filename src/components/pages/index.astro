---
import { getI18N } from "@/i18n";

import LineVertical from "@/assets/lines/line-vertical.svg";
import LineHorizontal1 from "@/assets/lines/line-horizontal-1.svg";
import LineHorizontal2 from "@/assets/lines/line-horizontal-2.svg";
import LineHorizontal3 from "@/assets/lines/line-horizontal-3.svg";
import LineHorizontal4 from "@/assets/lines/line-horizontal-4.svg";
import LineHorizontal5 from "@/assets/lines/line-horizontal-5.svg";

// New Section Components
import BioSection from "../home/BioSection.astro";
import MenuSection from "../home/MenuSection.astro";
import ProjectsSection from "../home/ProjectsSection.astro";
import BlogSection from "../home/BlogSection.astro";
import VideosSection from "../home/VideosSection.astro";
import SocialSection from "../home/SocialSection.astro";
import FooterSection from "../home/FooterSection.astro";
import ContactModal from "@/components/ContactModal.astro";

const { currentLocale } = Astro;
const i18n = getI18N({ currentLocale });
---

<div class="container">
  <div class="neo-left">
    <BioSection
      shortDescription={i18n.HOME.BIO.SHORT_DESCRIPTION}
      fullDescription={i18n.ABOUT.DESCRIPTION}
    />
    <div class="line-horizontal-2">
      <LineHorizontal2 />
    </div>
    <BlogSection />
    <div class="line-horizontal-4">
      <LineHorizontal1 />
    </div>
    <VideosSection />
  </div>
  <div class="line-vertical">
    <LineVertical />
  </div>
  <div class="line-horizontal-6">
    <LineHorizontal1 />
  </div>
  <!--  -->
  <div class="neo">
    <MenuSection />
    <div class="line-horizontal-1">
      <LineHorizontal1 />
    </div>
    <ProjectsSection />
    <div class="line-horizontal-3">
      <LineHorizontal3 />
    </div>
    <SocialSection />

    <div class="line-horizontal-5">
      <LineHorizontal5 />
    </div>
    <FooterSection />
  </div>
  <div class="neo-mobile">
    <MenuSection />
    <div class="line-horizontal-1">
      <LineHorizontal1 />
    </div>
    <BioSection
      shortDescription={i18n.HOME.BIO.SHORT_DESCRIPTION}
      fullDescription={i18n.ABOUT.DESCRIPTION}
    />
    <div class="line-horizontal-2">
      <LineHorizontal2 />
    </div>

    <ProjectsSection />
    <div class="line-horizontal-3">
      <LineHorizontal3 />
    </div>
    <BlogSection />
    <div class="line-horizontal-4">
      <LineHorizontal1 />
    </div>
    <VideosSection />
    <div class="line-vertical">
      <LineVertical />
    </div>
    <div class="line-horizontal-6">
      <LineHorizontal1 />
    </div>

    <SocialSection />

    <div class="line-horizontal-5">
      <LineHorizontal5 />
    </div>
    <FooterSection />
  </div>
</div>
<ContactModal />

<style>
  .container {
    height: 100%;
    box-sizing: border-box;
    padding: 1rem 2rem 2rem;
    display: grid;
    grid-template-areas: "neo-left               line-vertical neo";
    grid-template-columns: 7fr 5px 1fr;
    /* grid-template-rows: auto 5px auto 5px auto 5px auto 5px 1fr 5px 1fr; */
    grid-template-rows: 1fr;
    gap: 0;
    overflow: hidden;
  }

  .neo-left {
    grid-area: neo-left;
    height: fit-content;
  }
  .neo {
    grid-area: neo;
    height: fit-content;
  }

  .neo-mobile {
    display: none;
  }

  :global(.box) {
    padding: 1.5rem;
    display: flex;
    flex-direction: column;
  }

  .line-img {
    width: 100%;
    height: 100%;
    object-fit: fill;
    display: block;
  }

  :global(.bio) {
    grid-area: bio;
  }
  :global(.menu) {
    grid-area: menu;
  }
  :global(.projects) {
    grid-area: projects;
  }
  :global(.blog) {
    grid-area: blog;
  }
  :global(.videos) {
    grid-area: videos;
  }
  :global(.footer) {
    grid-area: footer;
  }
  :global(.social) {
    grid-area: social;
  }
  .line-vertical {
    grid-area: line-vertical;
    svg {
      height: 100%;
    }
  }
  .line-horizontal-1 {
    grid-area: line-horizontal-1;
    transform: translateX(-6px);
  }
  .line-horizontal-2 {
    grid-area: line-horizontal-2;
    transform: translateX(8px);
  }

  .line-horizontal-3 {
    grid-area: line-horizontal-3;
  }
  .line-horizontal-4 {
    grid-area: line-horizontal-4;
  }
  .line-horizontal-5 {
    grid-area: line-horizontal-5;
  }
  .line-horizontal-6 {
    display: none;
  }
  /* Responsive Adjustments */
  @media (width <= 1000px) {
    .neo {
      grid-area: auto;
      display: none;
    }
    .neo-left {
      display: none;
    }
    .neo-mobile {
      display: block;
    }
    .container {
      height: auto;
      padding: 0rem;
      grid-template-columns: 1fr;
      grid-template-rows: repeat(6, auto 5px) auto;
      grid-template-areas:
        "menu"
        "line-horizontal-1"
        "bio"
        "line-horizontal-2"
        "projects"
        "line-horizontal-3"
        "blog"
        "line-horizontal-4"
        "videos"
        "line-horizontal-5"
        "social"
        "line-horizontal-6"
        "footer";
    }

    .line-vertical {
      display: none;
    }
    .line-horizontal-6 {
      grid-area: line-horizontal-6;
      display: block;
    }
    .line-horizontal-1 {
      display: none;
    }
  }

  /* Prevent FOUC: Handled by Layout critical CSS */
</style>

<script>
  import { gsap } from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  function setupAnimations() {
    const isDesktop = matchMedia("(min-width: 1001px)").matches;

    // Reset any existing triggers
    ScrollTrigger.getAll().forEach((t) => t.kill());

    // --- ELEMENTS SELECTION ---
    // Lines
    const allPaths = document.querySelectorAll(
      '.line-vertical svg path, [class^="line-horizontal-"] svg path',
    );

    // Sections (Desktop) - Excluding lines
    const desktopSections = document.querySelectorAll(
      '.neo-left > :not([class^="line-"]), .neo > :not([class^="line-"])',
    );

    // Sections (Mobile)
    const mobileSections = document.querySelectorAll(
      '.neo-mobile > :not([class^="line-"])',
    );

    // --- INITIAL STATES ---
    // Hide Lines
    allPaths.forEach((line) => {
      const path = line as SVGPathElement;
      if (path.getTotalLength) {
        try {
          const length = path.getTotalLength();
          gsap.set(path, {
            strokeDasharray: length,
            strokeDashoffset: length,
            opacity: 1,
          });
        } catch (e) {
          console.warn("GSAP: Could not measure path length", line);
        }
      }
    });

    // Hide Sections (Desktop & Mobile)
    const allSections = [...desktopSections, ...mobileSections];
    gsap.set(allSections, { opacity: 0 });

    // REVEAL CONTAINER: Content is ready, children are hidden by GSAP, now show the container
    document.body.classList.add("loaded");

    // --- ANIMATION LOGIC ---
    if (isDesktop) {
      // DESKTOP: Coordinated Timeline
      const tl = gsap.timeline({
        scrollTrigger: {
          trigger: ".container",
          start: "top 75%",
          toggleActions: "play none none reverse",
        },
      });

      // 1. Central Vertical Line
      const verticalLine = document.querySelector(".line-vertical svg path");

      // 2. Horizontal Lines
      const horizontalLinesLeft = document.querySelectorAll(
        ".neo-left [class^='line-horizontal-'] svg path",
      );
      const horizontalLinesRight = document.querySelectorAll(
        ".neo [class^='line-horizontal-'] svg path",
      );
      const horizontalLines = [...horizontalLinesLeft, ...horizontalLinesRight];

      if (verticalLine) {
        tl.to(verticalLine, {
          strokeDashoffset: 0,
          duration: 1.2,
          ease: "power2.inOut",
        });
      }

      if (horizontalLines.length > 0) {
        // Overlap slightly with vertical line
        tl.to(
          horizontalLines,
          {
            strokeDashoffset: 0,
            duration: 1,
            stagger: 0.1,
            ease: "power2.out",
          },
          "-=0.8",
        );
      }

      if (desktopSections.length > 0) {
        // Sections fade in one by one (Pure Fade)
        tl.to(
          desktopSections,
          {
            opacity: 1,
            duration: 0.8,
            stagger: 0.1,
            ease: "power2.out",
          },
          "<",
        ); // Start same time as horizontal lines
      }
    } else {
      // MOBILE: Individual ScrollTriggers

      // 1. Lines
      const mobileLines = document.querySelectorAll(
        ".neo-mobile [class^='line-horizontal-'] svg path, .neo-mobile .line-vertical svg path",
      );
      mobileLines.forEach((line) => {
        const path = line as SVGPathElement;
        gsap.to(path, {
          strokeDashoffset: 0,
          duration: 1.2,
          ease: "power2.out",
          scrollTrigger: {
            trigger: path.closest("div"),
            start: "top 95%",
            toggleActions: "play none none none",
          },
        });
      });

      // 2. Sections
      mobileSections.forEach((section) => {
        gsap.to(section, {
          opacity: 1,
          duration: 0.8,
          ease: "power2.out",
          scrollTrigger: {
            trigger: section,
            start: "top 95%",
            toggleActions: "play none none none",
          },
        });
      });
    }
  }

  function setupWithoutAnimation() {
    document.body.classList.add("loaded");
  }
  // Run after all resources (images, fonts) are loaded for the initial visit
  if (document.readyState === "complete") {
    setupAnimations();
  } else {
    window.addEventListener("load", setupAnimations);
  }

  // Re-run after view transitions (Astro's navigation)
  document.addEventListener("astro:after-swap", setupWithoutAnimation);

  // Safety Fallback: Ensure page is visible if something hangs
  setTimeout(() => {
    if (!document.body.classList.contains("loaded")) {
      document.body.classList.add("loaded");
    }
  }, 3000);
</script>
