---
import CornerTopLeft from "@/assets/corner-top-left.svg";
import drawWallpaper from "@/assets/draw-wallpaper.png";

interface Props {
    id: string;
    title?: string;
}

const { id, title } = Astro.props;
---

<dialog id={id}>
    <div class="modal-master">
        <div class="modal-content">
            <CornerTopLeft />
            <button
                class="close-button bright"
                aria-label="Close modal"
                commandfor={id}
                command="close"
            >
                <svg
                    xmlns="http://www.w3.org/2000/svg"
                    width="24"
                    height="24"
                    viewBox="0 0 24 24"
                    fill="none"
                    stroke="var(--primary-text)"
                    stroke-width="2"
                    stroke-linecap="round"
                    stroke-linejoin="round"
                >
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
            <div class="modal-header">
                {title && <h2>{title}</h2>}
            </div>
            <slot />
        </div>
    </div>
</dialog>

<style define:vars={{ drawWallpaper: `url("${drawWallpaper.src}")` }}>
    svg:first-child {
        transform: rotate(90deg);
        position: absolute;
        top: -1px;
        right: -1.3px;
        width: 3rem;
        height: 3rem;
        z-index: 1;
    }
    dialog * {
        font-family: monospace;
    }
    dialog {
        padding: 0;
        border: none;
        background: transparent;
        max-width: 500px;
        width: 100%;

        /* Native dialog centering and sizing */
        margin: auto;
        @media (width <= 640px) {
            width: calc(100% - 1.5 rem);
        }

        /* Animation defaults */
        opacity: 0;
        transform: scale(0.9);
        transition:
            opacity 0.3s ease-out,
            transform 0.3s ease-out,
            display 0.3s ease-out allow-discrete;
    }

    /* Styling specifically when the dialog is open as a modal */
    dialog:modal {
        opacity: 1;
        transform: scale(1);
    }

    /* Starting state for animation */
    @starting-style {
        dialog:modal {
            opacity: 0;
            transform: scale(0.9);
        }
    }

    dialog::backdrop {
        background: rgba(0, 0, 0, 0.6);
        /* backdrop-filter: blur(4px); */
        opacity: 0;
        transition:
            opacity 0.3s ease-out,
            display 0.3s ease-out allow-discrete;
    }

    dialog:modal::backdrop {
        opacity: 1;
    }

    @starting-style {
        dialog:modal::backdrop {
            opacity: 0;
        }
    }
    .modal-master {
        border: 0.5px solid var(--border-line);
        background-color: var(--primary-bg);
        border-radius: 7px;
        padding: 0.5rem;
        overflow: hidden;
    }
    .modal-content {
        position: relative;
        border-radius: 7px;
        color: var(--primary-text);
        padding: clamp(1.5rem, 5vw, 2rem);
        border: 1px solid var(--border-line);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        position: relative; /* Ensure it's above texture if needed */
    }

    .modal-header h2 {
        margin: 0;
        font-size: 1.5rem;
    }

    .close-button {
        background: none;
        border: none;
        cursor: pointer;
        color: var(--primar-text);
        padding: 1.1rem;
        margin-top: 8px;
        margin-right: 5px;
        display: flex;
        align-items: center;
        justify-content: center;
        margin-left: auto;
        z-index: 10;
        position: absolute;
        top: 0;
        right: 0;
        height: 1rem;
        width: 1rem;
    }
    .close-button svg {
        display: block;
        width: 70%;
        height: 70%;
    }

    .modal-content::before {
        content: "123";
        position: absolute;
        inset: 0;
        background-image: var(--drawWallpaper);
        background-size: 500px;
        background-repeat: repeat;
        opacity: 0.08;
        /* z-index: -1; */
        pointer-events: none;
        filter: invert(1);
    }

    :global(.dark) .modal-content::before {
        filter: invert(0);
        opacity: 0.05;
    }
</style>

<script define:vars={{ id }}>
    function setupDialog() {
        const dialog = document.getElementById(id);
        if (!dialog) return;

        // Close on backdrop click
        dialog.addEventListener("click", (e) => {
            const rect = dialog.getBoundingClientRect();
            const isInDialog =
                rect.top <= e.clientY &&
                e.clientY <= rect.top + rect.height &&
                rect.left <= e.clientX &&
                e.clientX <= rect.left + rect.width;

            if (!isInDialog) {
                dialog.close();
            }
        });
    }

    setupDialog();
    document.addEventListener("astro:after-swap", setupDialog);
</script>
